# 1ë‹¨ê³„: Go ë¹Œë“œ
FROM golang:1.25-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN go build -o main .

# 2ë‹¨ê³„: ì‹¤í–‰ í™˜ê²½ (Python + Torch í¬í•¨)
FROM python:3.9-slim
WORKDIR /app

# Go ì‹¤í–‰ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/main .
COPY aggregate.py .
COPY requirements.txt .

# ğŸ› ï¸ PyTorch CPU ë²„ì „ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
# --no-cache-dir ì˜µì…˜ìœ¼ë¡œ ë„ì»¤ ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.
RUN pip install --no-cache-dir -r requirements.txt

# ê°€ì¤‘ì¹˜ ì €ì¥ìš© í´ë”
RUN mkdir -p storage

EXPOSE 8080
CMD ["./main"]